<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>c&#39;t-Bot: tcp-server.c Quellcode</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">c&#39;t-Bot
   &#160;<span id="projectnumber">1898</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Erzeugt von Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Hauptseite</span></a></li>
      <li><a href="pages.html"><span>Zusätzliche&#160;Informationen</span></a></li>
      <li><a href="annotated.html"><span>Datenstrukturen</span></a></li>
      <li class="current"><a href="files.html"><span>Dateien</span></a></li>
      <li><a href="dirs.html"><span>Verzeichnisse</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>Auflistung&#160;der&#160;Dateien</span></a></li>
      <li><a href="globals.html"><span>Datei-Elemente</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_5e2f2d5041bf6d2345ec9cc9dd1b53a1.html">pc</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">tcp-server.c</div>  </div>
</div>
<div class="contents">
<a href="tcp-server_8c.html">gehe zur Dokumentation dieser Datei</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * c&#39;t-Bot</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it</span>
<a name="l00005"></a>00005 <span class="comment"> * and/or modify it under the terms of the GNU General</span>
<a name="l00006"></a>00006 <span class="comment"> * Public License as published by the Free Software</span>
<a name="l00007"></a>00007 <span class="comment"> * Foundation; either version 2 of the License, or (at your</span>
<a name="l00008"></a>00008 <span class="comment"> * option) any later version.</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be</span>
<a name="l00010"></a>00010 <span class="comment"> * useful, but WITHOUT ANY WARRANTY; without even the implied</span>
<a name="l00011"></a>00011 <span class="comment"> * warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR</span>
<a name="l00012"></a>00012 <span class="comment"> * PURPOSE. See the GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> * You should have received a copy of the GNU General Public</span>
<a name="l00014"></a>00014 <span class="comment"> * License along with this program; if not, write to the Free</span>
<a name="l00015"></a>00015 <span class="comment"> * Software Foundation, Inc., 59 Temple Place, Suite 330, Boston,</span>
<a name="l00016"></a>00016 <span class="comment"> * MA 02111-1307, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> */</span>
<a name="l00019"></a>00019 
<a name="l00027"></a>00027 <span class="preprocessor">#ifdef PC</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="ct-Bot_8h.html" title="globale Schalter fuer die einzelnen Bot-Funktionalitaeten">ct-Bot.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="command_8h.html" title="Kommando-Management.">command.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="bot-2-sim_8h.html" title="Verbindung c&#39;t-Bot zu c&#39;t-Sim.">bot-2-sim.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="tcp_8h.html" title="TCP/IP-Kommunikation.">tcp.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="tcp-server_8h.html" title="Demo-TCP-Server.">tcp-server.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="display_8h.html" title="Routinen zur Displaysteuerung.">display.h</a>&quot;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="comment">/* Linux with glibc:</span>
<a name="l00041"></a>00041 <span class="comment"> *   _REENTRANT to grab thread-safe libraries</span>
<a name="l00042"></a>00042 <span class="comment"> *   _POSIX_SOURCE to get POSIX semantics</span>
<a name="l00043"></a>00043 <span class="comment"> */</span>
<a name="l00044"></a>00044 <span class="preprocessor">#ifndef WIN32</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span><span class="preprocessor">#define _REENTRANT</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span><span class="comment">//#define _POSIX_SOURCE</span>
<a name="l00047"></a>00047 <span class="preprocessor">#else</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="comment">//#define WIN32</span>
<a name="l00049"></a>00049 <span class="preprocessor">#endif</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span>
<a name="l00051"></a>00051 <span class="comment">/* Hack for LinuxThreads */</span>
<a name="l00052"></a>00052 <span class="preprocessor">#ifdef __linux__</span>
<a name="l00053"></a><a class="code" href="tcp-server_8c.html#a1bf6c868670adced4756500721b9d6ae">00053</a> <span class="preprocessor"></span><span class="preprocessor">#  define _P __P</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span>
<a name="l00056"></a>00056 <span class="preprocessor">#ifdef WIN32</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span><span class="preprocessor">#include &lt;winsock.h&gt;</span>
<a name="l00058"></a><a class="code" href="tcp-server_8c.html#a6b82106923cc13b3a9734520ecc29514">00058</a> <span class="keyword">typedef</span> <span class="keywordtype">int</span> <a class="code" href="tcp-server_8c.html#a6b82106923cc13b3a9734520ecc29514">socklen_t</a>;
<a name="l00059"></a>00059 <span class="preprocessor">#else</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span><span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#endif</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &lt;stdio.h&gt;</span>      <span class="comment">// for printf() and fprintf()</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>     <span class="comment">// for atoi() and exit()</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &lt;string.h&gt;</span>     <span class="comment">// for memset()</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &lt;unistd.h&gt;</span>     <span class="comment">// for close()</span>
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="keyword">static</span> <span class="keywordtype">int</span> server;                    
<a name="l00072"></a>00072 <span class="keyword">static</span> <span class="keyword">struct </span>sockaddr_in serverAddr; 
<a name="l00073"></a>00073 <span class="keyword">static</span> <span class="keyword">struct </span>sockaddr_in clientAddr; 
<a name="l00074"></a>00074 <span class="keyword">static</span> <a class="code" href="tcp-server_8c.html#a6b82106923cc13b3a9734520ecc29514">socklen_t</a> clntLen;          
<a name="l00079"></a><a class="code" href="tcp-server_8c.html#a1064c47dd79ee34077d1983e415b5ca7">00079</a> <span class="keywordtype">void</span> <a class="code" href="tcp-server_8h.html#a1064c47dd79ee34077d1983e415b5ca7">tcp_server_init</a>(<span class="keywordtype">void</span>) {
<a name="l00080"></a>00080 <span class="preprocessor">#ifdef WIN32</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span>    WSADATA wsaData;
<a name="l00082"></a>00082     WORD wVersionRequested;
<a name="l00083"></a>00083     <span class="keywordtype">int</span> err;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085     wVersionRequested = MAKEWORD(2, 0); <span class="comment">// 2.0 and above version of WinSock</span>
<a name="l00086"></a>00086     err = WSAStartup(wVersionRequested, &amp;wsaData);
<a name="l00087"></a>00087     <span class="keywordflow">if</span> (err != 0) {
<a name="l00088"></a>00088         printf(<span class="stringliteral">&quot;Couldn&#39;t not find a usable WinSock DLL.\n&quot;</span>);
<a name="l00089"></a>00089         exit(1);
<a name="l00090"></a>00090     }
<a name="l00091"></a>00091 <span class="preprocessor">#endif</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span>
<a name="l00093"></a>00093     <span class="comment">/* Wir geben uns als Sim aus, weil die Pakete mit derselben Zieladresse</span>
<a name="l00094"></a>00094 <span class="comment">     * wieder zurueckkommen */</span>
<a name="l00095"></a>00095     set_bot_address(<a class="code" href="command_8h.html#a2bfaf49b18ece53c96edc2424905adf4">CMD_SIM_ADDR</a>);
<a name="l00096"></a>00096 
<a name="l00097"></a>00097     <span class="comment">/* Create socket for incoming connections */</span>
<a name="l00098"></a>00098     <span class="keywordflow">if</span> ((server = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; 0) {
<a name="l00099"></a>00099         printf(<span class="stringliteral">&quot;socket() failed\n&quot;</span>);
<a name="l00100"></a>00100         exit(1);
<a name="l00101"></a>00101     }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103     <span class="keywordtype">int</span> <a class="code" href="behaviour__drive__chess_8c.html#a9aa40e637eff435d9abc0f4dc467b6bb">i</a> = 1;
<a name="l00104"></a>00104     setsockopt(server, SOL_SOCKET, SO_REUSEADDR, (<span class="keywordtype">char</span> *)&amp;i, <span class="keyword">sizeof</span>(i));
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     memset(&amp;serverAddr, 0, <span class="keyword">sizeof</span>(serverAddr));   <span class="comment">// Clean up</span>
<a name="l00107"></a>00107     serverAddr.sin_family = AF_INET;              <span class="comment">// Internet address family</span>
<a name="l00108"></a>00108     serverAddr.sin_addr.s_addr = htonl(INADDR_ANY); <span class="comment">// Any incoming interface</span>
<a name="l00109"></a>00109     serverAddr.sin_port = htons(<a class="code" href="tcp_8h.html#a614217d263be1fb1a5f76e2ff7be19a2">PORT</a>);      <span class="comment">// Local port to listen on</span>
<a name="l00110"></a>00110 
<a name="l00111"></a>00111     <span class="comment">/* Bind to the local address */</span>
<a name="l00112"></a>00112     <span class="keywordflow">if</span> (bind(server, (<span class="keyword">struct</span> sockaddr *) &amp;serverAddr, <span class="keyword">sizeof</span>(serverAddr)) &lt; 0) {
<a name="l00113"></a>00113         printf(<span class="stringliteral">&quot;bind() failed\n&quot;</span>);
<a name="l00114"></a>00114         exit(1);
<a name="l00115"></a>00115     }
<a name="l00116"></a>00116 
<a name="l00117"></a>00117     <span class="comment">/* Mark the socket so it will listen for incoming connections */</span>
<a name="l00118"></a>00118     <span class="keywordflow">if</span> (listen(server, 5) &lt; 0) {
<a name="l00119"></a>00119         printf(<span class="stringliteral">&quot;listen() failed\n&quot;</span>);
<a name="l00120"></a>00120         exit(1);
<a name="l00121"></a>00121     }
<a name="l00122"></a>00122 }
<a name="l00123"></a>00123 
<a name="l00128"></a><a class="code" href="tcp-server_8c.html#ace4243c07e325ba60c2eeb228743ea1b">00128</a> <span class="keywordtype">void</span> <a class="code" href="tcp-server_8h.html#ace4243c07e325ba60c2eeb228743ea1b">tcp_server_run</a>(<span class="keywordtype">int</span> runs) {
<a name="l00129"></a>00129     <span class="keywordtype">char</span> buffer[<a class="code" href="command_8h.html#aa7a7521abb3a3664218d8dc0e3759f0f">MAX_PAYLOAD</a> + <span class="keyword">sizeof</span>(command_t)];
<a name="l00130"></a>00130     <span class="keyword">struct </span>timeval start, stop;
<a name="l00131"></a>00131     printf(<span class="stringliteral">&quot;TCP-Server alive\n&quot;</span>);
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     uint8_t seq = 1;
<a name="l00134"></a>00134     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> t_sum = 0, t2_sum = 0;
<a name="l00135"></a>00135 
<a name="l00136"></a>00136     <span class="comment">/* Set the size of the in-out parameter */</span>
<a name="l00137"></a>00137     clntLen = <span class="keyword">sizeof</span>(clientAddr);
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     <span class="comment">/* Wait for a client to connect */</span>
<a name="l00140"></a>00140     printf(<span class="stringliteral">&quot;Waiting for client\n&quot;</span>);
<a name="l00141"></a>00141     <span class="keywordflow">if</span> ((<a class="code" href="tcp_8h.html#a16829ea6c4b65cc928ce596bd036fa9b">tcp_sock</a> = <a class="code" href="ubasic_8c.html#aa2d72051274fdc2aafa92cf26f8f8189">accept</a>(server, (<span class="keyword">struct</span> sockaddr *) &amp;clientAddr, &amp;clntLen)) &lt; 0) {
<a name="l00142"></a>00142         printf(<span class="stringliteral">&quot;accept() failed&quot;</span>);
<a name="l00143"></a>00143     }
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     printf(<span class="stringliteral">&quot;Connected to %s on Port: %u\n&quot;</span>, inet_ntoa(clientAddr.sin_addr), <a class="code" href="tcp_8h.html#a614217d263be1fb1a5f76e2ff7be19a2">PORT</a>);
<a name="l00146"></a>00146 
<a name="l00147"></a>00147     int16_t <a class="code" href="sensor_8c.html#aec3ee6f76a66fefc987aa122e1073a21">simultime</a> = 0;
<a name="l00148"></a>00148     <span class="keywordtype">int</span> <a class="code" href="behaviour__drive__chess_8c.html#a9aa40e637eff435d9abc0f4dc467b6bb">i</a>;
<a name="l00149"></a>00149     <span class="keywordflow">for</span> (i=0; i&lt;runs; i++) {
<a name="l00150"></a>00150         simultime += 10;
<a name="l00151"></a>00151         <span class="comment">//printf(&quot;i=%d\n&quot;, i);</span>
<a name="l00152"></a>00152         GETTIMEOFDAY(&amp;start, NULL);
<a name="l00153"></a>00153         <a class="code" href="command_8c.html#a419b75ed34551408822d9caee3cd5206">command_write</a>(<a class="code" href="command_8h.html#a05c19117c56d09759fc70d0167ec5b3d">CMD_SENS_IR</a>, <a class="code" href="command_8h.html#a35cc95952674b5c7e9b0061af6a4742f">SUB_CMD_NORM</a>, simultime, 0, 0);
<a name="l00154"></a>00154         <a class="code" href="command_8c.html#a419b75ed34551408822d9caee3cd5206">command_write</a>(<a class="code" href="command_8h.html#aafd1c62c002ec9e13df526774a61087e">CMD_SENS_ENC</a>, <a class="code" href="command_8h.html#a35cc95952674b5c7e9b0061af6a4742f">SUB_CMD_NORM</a>, simultime, simultime, 0);
<a name="l00155"></a>00155         <a class="code" href="command_8c.html#a419b75ed34551408822d9caee3cd5206">command_write</a>(<a class="code" href="command_8h.html#af713c4f6167335d20267ec2d0fc33adf">CMD_SENS_BORDER</a>, <a class="code" href="command_8h.html#a35cc95952674b5c7e9b0061af6a4742f">SUB_CMD_NORM</a>, simultime, simultime, 0);
<a name="l00156"></a>00156         <a class="code" href="command_8c.html#a419b75ed34551408822d9caee3cd5206">command_write</a>(<a class="code" href="command_8h.html#a3d9b86bae56b6374862b7865a3548846">CMD_SENS_LINE</a>, <a class="code" href="command_8h.html#a35cc95952674b5c7e9b0061af6a4742f">SUB_CMD_NORM</a>, simultime, simultime, 0);
<a name="l00157"></a>00157         <a class="code" href="command_8c.html#a419b75ed34551408822d9caee3cd5206">command_write</a>(<a class="code" href="command_8h.html#ad96f0a16395f789d7e94d01fed4bfd40">CMD_SENS_LDR</a>, <a class="code" href="command_8h.html#a35cc95952674b5c7e9b0061af6a4742f">SUB_CMD_NORM</a>, simultime, simultime, 0);
<a name="l00158"></a>00158         <a class="code" href="command_8c.html#a419b75ed34551408822d9caee3cd5206">command_write</a>(<a class="code" href="command_8h.html#aac5f604aee68879c01369f486b025ff2">CMD_SENS_TRANS</a>, <a class="code" href="command_8h.html#a35cc95952674b5c7e9b0061af6a4742f">SUB_CMD_NORM</a>, simultime, 0, 0);
<a name="l00159"></a>00159         <a class="code" href="command_8c.html#a419b75ed34551408822d9caee3cd5206">command_write</a>(<a class="code" href="command_8h.html#a46a160fb1f3b04fcb64c901a941b5c8d">CMD_SENS_DOOR</a>, <a class="code" href="command_8h.html#a35cc95952674b5c7e9b0061af6a4742f">SUB_CMD_NORM</a>, simultime, 0, 0);
<a name="l00160"></a>00160         <a class="code" href="command_8c.html#a419b75ed34551408822d9caee3cd5206">command_write</a>(<a class="code" href="command_8h.html#a52f23611d45ba9cdaad25f0d8380ddb0">CMD_SENS_MOUSE</a>, <a class="code" href="command_8h.html#a35cc95952674b5c7e9b0061af6a4742f">SUB_CMD_NORM</a>, simultime, simultime, 0);
<a name="l00161"></a>00161         <a class="code" href="command_8c.html#a419b75ed34551408822d9caee3cd5206">command_write</a>(<a class="code" href="command_8h.html#a389c16135b110b6b0ca2d0863bc64999">CMD_SENS_ERROR</a>, <a class="code" href="command_8h.html#a35cc95952674b5c7e9b0061af6a4742f">SUB_CMD_NORM</a>, simultime, 0, 0);
<a name="l00162"></a>00162         <a class="code" href="command_8c.html#a419b75ed34551408822d9caee3cd5206">command_write</a>(<a class="code" href="command_8h.html#a9b17cedc408a9f7ed418e251d64aee6e">CMD_SENS_RC5</a>, <a class="code" href="command_8h.html#a35cc95952674b5c7e9b0061af6a4742f">SUB_CMD_NORM</a>, simultime, 0, 0);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164         <a class="code" href="command_8c.html#a419b75ed34551408822d9caee3cd5206">command_write</a>(<a class="code" href="command_8h.html#acf09403e2c65651efc168d455792a642">CMD_DONE</a>, <a class="code" href="command_8h.html#a35cc95952674b5c7e9b0061af6a4742f">SUB_CMD_NORM</a>, simultime, 0, 0);
<a name="l00165"></a>00165         <a class="code" href="tcp_8h.html#aae71e1682727310afab282923a80c968">flushSendBuffer</a>();
<a name="l00166"></a>00166 
<a name="l00167"></a>00167         GETTIMEOFDAY(&amp;stop, NULL);
<a name="l00168"></a>00168         <span class="keywordtype">int</span> t2 = (stop.tv_sec - start.tv_sec)*1000000 + stop.tv_usec
<a name="l00169"></a>00169                 - start.tv_usec;
<a name="l00170"></a>00170         t2_sum += t2;
<a name="l00171"></a>00171         printf(<span class="stringliteral">&quot;X-Token (%u) out after %u usec\n&quot;</span>, simultime, t2);
<a name="l00172"></a>00172 
<a name="l00173"></a>00173         <a class="code" href="command_8c.html#ac0048910da59c3a22177b20c8ce0b3b6" title="Puffer fuer Kommandos.">received_command</a>.request.command = 0;
<a name="l00174"></a>00174         GETTIMEOFDAY(&amp;start, NULL);
<a name="l00175"></a>00175         <span class="keywordflow">while</span> (<a class="code" href="command_8c.html#ac0048910da59c3a22177b20c8ce0b3b6" title="Puffer fuer Kommandos.">received_command</a>.request.command != <a class="code" href="command_8h.html#acf09403e2c65651efc168d455792a642">CMD_DONE</a>) {
<a name="l00176"></a>00176             int8_t res = <a class="code" href="command_8c.html#a710f03c0bca16a1965fc97647f41ee06">command_read</a>();
<a name="l00177"></a>00177             <span class="comment">//printf(&quot;Command read, result=%d\n&quot;, res);</span>
<a name="l00178"></a>00178             <span class="keywordflow">if</span> (res != 0) {
<a name="l00179"></a>00179                 <span class="comment">/* Fehler */</span>
<a name="l00180"></a>00180                 printf(<span class="stringliteral">&quot;Probleme beim Lesen eines Kommandos\n&quot;</span>);
<a name="l00181"></a>00181             } <span class="keywordflow">else</span> {
<a name="l00182"></a>00182                 <span class="comment">/* Alles ok, evtl. muessen wir aber eine Payload abholen */</span>
<a name="l00183"></a>00183                 <span class="keywordflow">if</span> (<a class="code" href="command_8c.html#ac0048910da59c3a22177b20c8ce0b3b6" title="Puffer fuer Kommandos.">received_command</a>.payload != 0) {
<a name="l00184"></a>00184                     printf(<span class="stringliteral">&quot;fetching payload (%u bytes)\n&quot;</span>, <a class="code" href="command_8c.html#ac0048910da59c3a22177b20c8ce0b3b6" title="Puffer fuer Kommandos.">received_command</a>.payload);
<a name="l00185"></a>00185                     <a class="code" href="command_8h.html#a7b73b86c514a68c1d7598f9bc98bbfea">low_read</a>(buffer, <a class="code" href="command_8c.html#ac0048910da59c3a22177b20c8ce0b3b6" title="Puffer fuer Kommandos.">received_command</a>.payload);
<a name="l00186"></a>00186                 }
<a name="l00187"></a>00187                 <span class="keywordflow">if</span> (<a class="code" href="command_8c.html#ac0048910da59c3a22177b20c8ce0b3b6" title="Puffer fuer Kommandos.">received_command</a>.seq != seq) {
<a name="l00188"></a>00188                     printf(<span class="stringliteral">&quot;Sequenzzaehler falsch! Erwartet: %u Empfangen %u\n&quot;</span>, seq, <a class="code" href="command_8c.html#ac0048910da59c3a22177b20c8ce0b3b6" title="Puffer fuer Kommandos.">received_command</a>.seq);
<a name="l00189"></a>00189                 }
<a name="l00190"></a>00190             }
<a name="l00191"></a>00191             seq = <a class="code" href="command_8c.html#ac0048910da59c3a22177b20c8ce0b3b6" title="Puffer fuer Kommandos.">received_command</a>.seq + 1;
<a name="l00192"></a>00192             <span class="comment">//printf(&quot;seq=%u\n&quot;, seq);</span>
<a name="l00193"></a>00193         }
<a name="l00194"></a>00194         GETTIMEOFDAY(&amp;stop, NULL);
<a name="l00195"></a>00195 
<a name="l00196"></a>00196         <span class="keywordtype">int</span> <a class="code" href="behaviour__drive__chess_8c.html#a652c1b1eb7ca53b7a24162760b2e2c59">t</a> = (stop.tv_sec - start.tv_sec)*1000000 + stop.tv_usec - start.tv_usec;
<a name="l00197"></a>00197         t_sum += t;
<a name="l00198"></a>00198         printf(<span class="stringliteral">&quot;X-Token (%u) back after %u usec\n&quot;</span>, <a class="code" href="command_8c.html#ac0048910da59c3a22177b20c8ce0b3b6" title="Puffer fuer Kommandos.">received_command</a>.data_l, t);
<a name="l00199"></a>00199 
<a name="l00200"></a>00200         <span class="keywordflow">if</span> (<a class="code" href="command_8c.html#ac0048910da59c3a22177b20c8ce0b3b6" title="Puffer fuer Kommandos.">received_command</a>.data_l != simultime) {
<a name="l00201"></a>00201             printf(<span class="stringliteral">&quot;Falschen X-Frame erhalten ==&gt; Exit\n&quot;</span>);
<a name="l00202"></a>00202             exit(0);
<a name="l00203"></a>00203         }
<a name="l00204"></a>00204     }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <span class="comment">/* Statistik */</span>
<a name="l00207"></a>00207     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mean_send = (double)t2_sum / (<span class="keywordtype">double</span>)<a class="code" href="behaviour__drive__chess_8c.html#a9aa40e637eff435d9abc0f4dc467b6bb">i</a>;
<a name="l00208"></a>00208     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mean_xfer = (double)t_sum / (2.0 * i);
<a name="l00209"></a>00209     printf(<span class="stringliteral">&quot;\nAverage sendtime: %u usec\nAverage transfertime (1-way): %u usec\n&quot;</span>, mean_send, mean_xfer);
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     printf(<span class="stringliteral">&quot;\nTCP-Server hat seine %d runs durch und beendet sich.\nSo long and thanks for all the fish!\n&quot;</span>, runs);
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="preprocessor">#ifdef WIN32</span>
<a name="l00214"></a>00214 <span class="preprocessor"></span>    WSACleanup();
<a name="l00215"></a>00215 <span class="preprocessor">#endif</span>
<a name="l00216"></a>00216 <span class="preprocessor"></span>    <a class="code" href="tcp_8h.html#a533156f7515b0fac54217758ded89cec">tcp_closeConnection</a>(<a class="code" href="tcp_8h.html#a16829ea6c4b65cc928ce596bd036fa9b">tcp_sock</a>);
<a name="l00217"></a>00217     exit(0);
<a name="l00218"></a>00218 }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 
<a name="l00224"></a><a class="code" href="tcp-server_8c.html#ae9f36864880c59f4b2e7f2cdbfa427be">00224</a> <span class="keywordtype">void</span> <a class="code" href="tcp-server_8h.html#ae9f36864880c59f4b2e7f2cdbfa427be">tcp_test_client_init</a>(<span class="keywordtype">void</span>) {
<a name="l00225"></a>00225     printf(<span class="stringliteral">&quot;Connecting Testclient to %s on Port: %d...\n&quot;</span>, <a class="code" href="tcp_8h.html#a5d2fc42a7b026cbdfc141449f37b3775">tcp_hostname</a>, 10001);
<a name="l00226"></a>00226     <a class="code" href="tcp_8h.html#a51de4ded7d342456d31722493c92c969">tcp_init</a>();
<a name="l00227"></a>00227 }
<a name="l00228"></a>00228 
<a name="l00233"></a><a class="code" href="tcp-server_8c.html#ae95ffb3258b0e976ccc4424b8f22103f">00233</a> <span class="keywordtype">void</span> <a class="code" href="tcp-server_8h.html#ae95ffb3258b0e976ccc4424b8f22103f">tcp_test_client_run</a>(<span class="keywordtype">int</span> runs) {
<a name="l00234"></a>00234     <span class="keywordtype">char</span> buffer[<span class="keyword">sizeof</span>(command_t)];
<a name="l00235"></a>00235 
<a name="l00236"></a>00236     <span class="keywordflow">if</span> (runs &gt; 0) {
<a name="l00237"></a>00237         printf(<span class="stringliteral">&quot;Answering %d frames\n&quot;</span>, runs);
<a name="l00238"></a>00238     } <span class="keywordflow">else</span> {
<a name="l00239"></a>00239         printf(<span class="stringliteral">&quot;Answering all frames\n&quot;</span>);
<a name="l00240"></a>00240     }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     <span class="keywordtype">int</span> <a class="code" href="behaviour__drive__chess_8c.html#a9aa40e637eff435d9abc0f4dc467b6bb">i</a>;
<a name="l00243"></a>00243     <span class="keywordflow">for</span>(i=0; runs==0 || i&lt;runs; i++) {
<a name="l00244"></a>00244         <span class="comment">//printf(&quot;i=%d\n&quot;, i);</span>
<a name="l00245"></a>00245         <span class="keywordtype">int</span> <a class="code" href="behaviour__drive__chess_8c.html#aac1217779551b743f5645c17740178e3">j</a>;
<a name="l00246"></a>00246         <span class="comment">/* 11 Commands lesen und zurueckschicken */</span>
<a name="l00247"></a>00247         <span class="keywordflow">for</span> (j=0; j&lt;11; j++) {
<a name="l00248"></a>00248             <span class="keywordtype">int</span> len = <a class="code" href="tcp_8h.html#a294129207dee66dc263765f8dd00351b">tcp_read</a>(buffer, <span class="keyword">sizeof</span>(command_t));
<a name="l00249"></a>00249             <span class="comment">//printf(&quot;len=%d\n&quot;, len);</span>
<a name="l00250"></a>00250             <a class="code" href="tcp_8h.html#abf5327c9ea7eb20615c07b4ffd833abb">tcp_write</a>(buffer, len);
<a name="l00251"></a>00251         }
<a name="l00252"></a>00252         <a class="code" href="tcp_8h.html#aae71e1682727310afab282923a80c968">flushSendBuffer</a>();
<a name="l00253"></a>00253         printf(<span class="stringliteral">&quot;.&quot;</span>);
<a name="l00254"></a>00254         fflush(stdout);
<a name="l00255"></a>00255     }
<a name="l00256"></a>00256     printf(<span class="stringliteral">&quot;\nFinished %d frames\n&quot;</span>, runs);
<a name="l00257"></a>00257     <a class="code" href="tcp_8h.html#a533156f7515b0fac54217758ded89cec">tcp_closeConnection</a>(<a class="code" href="tcp_8h.html#a16829ea6c4b65cc928ce596bd036fa9b">tcp_sock</a>);
<a name="l00258"></a>00258     exit(0);
<a name="l00259"></a>00259 }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261 <span class="preprocessor">#endif // PC</span>
</pre></div></div>
</div>


<hr class="footer"/><address class="footer"><small>
Erzeugt am Mit Feb 29 2012 14:18:09 für c't-Bot von &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
