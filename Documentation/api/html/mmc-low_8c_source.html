<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>c't-Bot: mmc-low.c Quellcode</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">c't-Bot
   &#160;<span id="projectnumber">1818</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Erzeugt von Doxygen 1.7.5 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Hauptseite</span></a></li>
      <li><a href="pages.html"><span>Zus√§tzliche&#160;Informationen</span></a></li>
      <li><a href="annotated.html"><span>Datenstrukturen</span></a></li>
      <li class="current"><a href="files.html"><span>Dateien</span></a></li>
      <li><a href="dirs.html"><span>Verzeichnisse</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>Auflistung&#160;der&#160;Dateien</span></a></li>
      <li><a href="globals.html"><span>Datei-Elemente</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_621229fa04310f844660a72d92a68ebe.html">mcu</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">mmc-low.c</div>  </div>
</div>
<div class="contents">
<a href="mmc-low_8c.html">gehe zur Dokumentation dieser Datei</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * c&#39;t-Bot</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it</span>
<a name="l00005"></a>00005 <span class="comment"> * and/or modify it under the terms of the GNU General</span>
<a name="l00006"></a>00006 <span class="comment"> * Public License as published by the Free Software</span>
<a name="l00007"></a>00007 <span class="comment"> * Foundation; either version 2 of the License, or (at your</span>
<a name="l00008"></a>00008 <span class="comment"> * option) any later version.</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be</span>
<a name="l00010"></a>00010 <span class="comment"> * useful, but WITHOUT ANY WARRANTY; without even the implied</span>
<a name="l00011"></a>00011 <span class="comment"> * warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR</span>
<a name="l00012"></a>00012 <span class="comment"> * PURPOSE. See the GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> * You should have received a copy of the GNU General Public</span>
<a name="l00014"></a>00014 <span class="comment"> * License along with this program; if not, write to the Free</span>
<a name="l00015"></a>00015 <span class="comment"> * Software Foundation, Inc., 59 Temple Place, Suite 330, Boston,</span>
<a name="l00016"></a>00016 <span class="comment"> * MA 02111-1307, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> */</span>
<a name="l00019"></a>00019 
<a name="l00027"></a>00027 <span class="preprocessor">#ifdef MCU</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="ct-Bot_8h.html" title="globale Schalter fuer die einzelnen Bot-Funktionalitaeten">ct-Bot.h</a>&quot;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#if defined MMC_AVAILABLE &amp;&amp; ! defined SPI_AVAILABLE</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="mmc_8h.html" title="Routinen zum Auslesen / Schreiben einer MMC-Karte.">mmc.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="mmc-low_8h.html" title="Low-Level-Routinen zum Lesen/Schreiben einer MMC / SD-Card.">mmc-low.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="ena_8h.html" title="Routinen zur Steuerung der Enable-Leitungen.">ena.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="led_8h.html" title="Routinen zur LED-Steuerung.">led.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;avr/io.h&gt;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="comment">/* Portkonfiguration */</span>
<a name="l00038"></a>00038 <span class="preprocessor">#define PORT_OUT _SFR_IO_ADDR(MMC_PORT_OUT)</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#define PORT_IN _SFR_IO_ADDR(MMC_PORT_IN)</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="preprocessor">#define DDR _SFR_IO_ADDR(MMC_DDR)</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>
<a name="l00042"></a>00042 <span class="keywordtype">void</span> <a class="code" href="mmc_8c.html#a33b293aa95d995d8903d5a687cb5e2a7">mmc_write_byte</a>(uint8_t data) <a class="code" href="init_8h.html#a87df7e6560f87322f737157d976f8e6f" title="Kopie des MCU(C)SR Registers.">__attribute__</a>((noinline));
<a name="l00047"></a>00047 <span class="keywordtype">void</span> <a class="code" href="mmc_8c.html#a33b293aa95d995d8903d5a687cb5e2a7">mmc_write_byte</a>(uint8_t data) {
<a name="l00048"></a>00048     uint8_t tmp;
<a name="l00049"></a>00049     __asm__ __volatile__(
<a name="l00050"></a>00050         <span class="stringliteral">&quot;in %0, %2          ; MMC_PORT_OUT einlesen \n\t&quot;</span>
<a name="l00051"></a>00051         <span class="stringliteral">&quot;cbr %0, %5         ; CLK auf low           \n\t&quot;</span>
<a name="l00052"></a>00052         <span class="stringliteral">&quot;bst %1, 7          ; Bit 7 der Daten       \n\t&quot;</span>
<a name="l00053"></a>00053         <span class="stringliteral">&quot;bld %0, %3         ; Daten nach DO         \n\t&quot;</span>
<a name="l00054"></a>00054         <span class="stringliteral">&quot;out %2, %0         ; Daten senden          \n\t&quot;</span>
<a name="l00055"></a>00055         <span class="stringliteral">&quot;sbi %2, %4         ; CLK auf high          \n\t&quot;</span>
<a name="l00056"></a>00056         <span class="stringliteral">&quot;bst %1, 6          ; Bit 6 der Daten       \n\t&quot;</span>
<a name="l00057"></a>00057         <span class="stringliteral">&quot;bld %0, %3                                 \n\t&quot;</span>
<a name="l00058"></a>00058         <span class="stringliteral">&quot;out %2, %0                                 \n\t&quot;</span>
<a name="l00059"></a>00059         <span class="stringliteral">&quot;sbi %2, %4                                 \n\t&quot;</span>
<a name="l00060"></a>00060         <span class="stringliteral">&quot;bst %1, 5          ; Bit 5 der Daten       \n\t&quot;</span>
<a name="l00061"></a>00061         <span class="stringliteral">&quot;bld %0, %3                                 \n\t&quot;</span>
<a name="l00062"></a>00062         <span class="stringliteral">&quot;out %2, %0                                 \n\t&quot;</span>
<a name="l00063"></a>00063         <span class="stringliteral">&quot;sbi %2, %4                                 \n\t&quot;</span>
<a name="l00064"></a>00064         <span class="stringliteral">&quot;bst %1, 4          ; Bit 4 der Daten       \n\t&quot;</span>
<a name="l00065"></a>00065         <span class="stringliteral">&quot;bld %0, %3                                 \n\t&quot;</span>
<a name="l00066"></a>00066         <span class="stringliteral">&quot;out %2, %0                                 \n\t&quot;</span>
<a name="l00067"></a>00067         <span class="stringliteral">&quot;sbi %2, %4                                 \n\t&quot;</span>
<a name="l00068"></a>00068         <span class="stringliteral">&quot;bst %1, 3          ; Bit 3 der Daten       \n\t&quot;</span>
<a name="l00069"></a>00069         <span class="stringliteral">&quot;bld %0, %3                                 \n\t&quot;</span>
<a name="l00070"></a>00070         <span class="stringliteral">&quot;out %2, %0                                 \n\t&quot;</span>
<a name="l00071"></a>00071         <span class="stringliteral">&quot;sbi %2, %4                                 \n\t&quot;</span>
<a name="l00072"></a>00072         <span class="stringliteral">&quot;bst %1, 2          ; Bit 2 der Daten       \n\t&quot;</span>
<a name="l00073"></a>00073         <span class="stringliteral">&quot;bld %0, %3                                 \n\t&quot;</span>
<a name="l00074"></a>00074         <span class="stringliteral">&quot;out %2, %0                                 \n\t&quot;</span>
<a name="l00075"></a>00075         <span class="stringliteral">&quot;sbi %2, %4                                 \n\t&quot;</span>
<a name="l00076"></a>00076         <span class="stringliteral">&quot;bst %1, 1          ; Bit 1 der Daten       \n\t&quot;</span>
<a name="l00077"></a>00077         <span class="stringliteral">&quot;bld %0, %3                                 \n\t&quot;</span>
<a name="l00078"></a>00078         <span class="stringliteral">&quot;out %2, %0                                 \n\t&quot;</span>
<a name="l00079"></a>00079         <span class="stringliteral">&quot;sbi %2, %4                                 \n\t&quot;</span>
<a name="l00080"></a>00080         <span class="stringliteral">&quot;bst %1, 0          ; Bit 0 der Daten       \n\t&quot;</span>
<a name="l00081"></a>00081         <span class="stringliteral">&quot;bld %0, %3                                 \n\t&quot;</span>
<a name="l00082"></a>00082         <span class="stringliteral">&quot;out %2, %0                                 \n\t&quot;</span>
<a name="l00083"></a>00083         <span class="stringliteral">&quot;sbi %2, %4                                 \n\t&quot;</span>
<a name="l00084"></a>00084         <span class="stringliteral">&quot;sbi %2, %3         ; DO auf high               &quot;</span>
<a name="l00085"></a>00085         : <span class="stringliteral">&quot;=&amp;r&quot;</span> (tmp) <span class="comment">/* %0 */</span>
<a name="l00086"></a>00086         : <span class="stringliteral">&quot;r&quot;</span> (data) <span class="comment">/* %1 */</span>, <span class="stringliteral">&quot;M&quot;</span> (PORT_OUT) <span class="comment">/* %2 */</span>, <span class="stringliteral">&quot;M&quot;</span> (<a class="code" href="mmc-low_8h.html#a8c0bc6cc240b5384d0a3c3778a2b0b12">SPI_DO</a>) <span class="comment">/* %3 */</span>, <span class="stringliteral">&quot;M&quot;</span> (<a class="code" href="mmc-low_8h.html#af3cfe48f6efdc257518227b43c1bc3df">SPI_CLK</a>) <span class="comment">/* %4 */</span>, <span class="stringliteral">&quot;M&quot;</span> (_BV(<a class="code" href="mmc-low_8h.html#af3cfe48f6efdc257518227b43c1bc3df">SPI_CLK</a>)) <span class="comment">/* %5 */</span>
<a name="l00087"></a>00087         : <span class="stringliteral">&quot;memory&quot;</span>
<a name="l00088"></a>00088     );
<a name="l00089"></a>00089 }
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 uint8_t <a class="code" href="mmc_8c.html#a4f77044232e9cffe7e4c1fa8d24dcd22">mmc_read_byte</a>(<span class="keywordtype">void</span>) <a class="code" href="init_8h.html#a87df7e6560f87322f737157d976f8e6f" title="Kopie des MCU(C)SR Registers.">__attribute__</a>((noinline));
<a name="l00097"></a>00097 uint8_t <a class="code" href="mmc_8c.html#a4f77044232e9cffe7e4c1fa8d24dcd22">mmc_read_byte</a>(<span class="keywordtype">void</span>) {
<a name="l00098"></a>00098     uint8_t clk_high, clk_low, port_data, data;
<a name="l00099"></a>00099     __asm__ __volatile__(
<a name="l00100"></a>00100         <span class="stringliteral">&quot;in %2, %4      ; MMC_PORT_OUT einlesen \n\t&quot;</span>
<a name="l00101"></a>00101         <span class="stringliteral">&quot;cbr %2, %7     ; CLK low               \n\t&quot;</span>
<a name="l00102"></a>00102         <span class="stringliteral">&quot;out %4, %2     ; CLK auf low           \n\t&quot;</span>
<a name="l00103"></a>00103         <span class="stringliteral">&quot;mov %1, %2     ; CLK high              \n\t&quot;</span>
<a name="l00104"></a>00104         <span class="stringliteral">&quot;sbr %1, %7                             \n\t&quot;</span>
<a name="l00105"></a>00105         <span class="stringliteral">&quot;in %3, %5      ; Bit 7 lesen           \n\t&quot;</span>
<a name="l00106"></a>00106         <span class="stringliteral">&quot;out %4, %1     ; CLK Flanke            \n\t&quot;</span>
<a name="l00107"></a>00107         <span class="stringliteral">&quot;out %4, %2                             \n\t&quot;</span>
<a name="l00108"></a>00108         <span class="stringliteral">&quot;bst %3, %6     ; Bit 7 speichern       \n\t&quot;</span>
<a name="l00109"></a>00109         <span class="stringliteral">&quot;bld %0, 7                              \n\t&quot;</span>
<a name="l00110"></a>00110         <span class="stringliteral">&quot;in %3, %5      ; Bit 6                 \n\t&quot;</span>
<a name="l00111"></a>00111         <span class="stringliteral">&quot;out %4, %1                             \n\t&quot;</span>
<a name="l00112"></a>00112         <span class="stringliteral">&quot;out %4, %2                             \n\t&quot;</span>
<a name="l00113"></a>00113         <span class="stringliteral">&quot;bst %3, %6                             \n\t&quot;</span>
<a name="l00114"></a>00114         <span class="stringliteral">&quot;bld %0, 6                              \n\t&quot;</span>
<a name="l00115"></a>00115         <span class="stringliteral">&quot;in %3, %5      ; Bit 5                 \n\t&quot;</span>
<a name="l00116"></a>00116         <span class="stringliteral">&quot;out %4, %1                             \n\t&quot;</span>
<a name="l00117"></a>00117         <span class="stringliteral">&quot;out %4, %2                             \n\t&quot;</span>
<a name="l00118"></a>00118         <span class="stringliteral">&quot;bst %3, %6                             \n\t&quot;</span>
<a name="l00119"></a>00119         <span class="stringliteral">&quot;bld %0, 5                              \n\t&quot;</span>
<a name="l00120"></a>00120         <span class="stringliteral">&quot;in %3, %5      ; Bit 4                 \n\t&quot;</span>
<a name="l00121"></a>00121         <span class="stringliteral">&quot;out %4, %1                             \n\t&quot;</span>
<a name="l00122"></a>00122         <span class="stringliteral">&quot;out %4, %2                             \n\t&quot;</span>
<a name="l00123"></a>00123         <span class="stringliteral">&quot;bst %3, %6                             \n\t&quot;</span>
<a name="l00124"></a>00124         <span class="stringliteral">&quot;bld %0, 4                              \n\t&quot;</span>
<a name="l00125"></a>00125         <span class="stringliteral">&quot;in %3, %5      ; Bit 3                 \n\t&quot;</span>
<a name="l00126"></a>00126         <span class="stringliteral">&quot;out %4, %1                             \n\t&quot;</span>
<a name="l00127"></a>00127         <span class="stringliteral">&quot;out %4, %2                             \n\t&quot;</span>
<a name="l00128"></a>00128         <span class="stringliteral">&quot;bst %3, %6                             \n\t&quot;</span>
<a name="l00129"></a>00129         <span class="stringliteral">&quot;bld %0, 3                              \n\t&quot;</span>
<a name="l00130"></a>00130         <span class="stringliteral">&quot;in %3, %5      ; Bit 2                 \n\t&quot;</span>
<a name="l00131"></a>00131         <span class="stringliteral">&quot;out %4, %1                             \n\t&quot;</span>
<a name="l00132"></a>00132         <span class="stringliteral">&quot;out %4, %2                             \n\t&quot;</span>
<a name="l00133"></a>00133         <span class="stringliteral">&quot;bst %3, %6                             \n\t&quot;</span>
<a name="l00134"></a>00134         <span class="stringliteral">&quot;bld %0, 2                              \n\t&quot;</span>
<a name="l00135"></a>00135         <span class="stringliteral">&quot;in %3, %5      ; Bit 1                 \n\t&quot;</span>
<a name="l00136"></a>00136         <span class="stringliteral">&quot;out %4, %1                             \n\t&quot;</span>
<a name="l00137"></a>00137         <span class="stringliteral">&quot;out %4, %2                             \n\t&quot;</span>
<a name="l00138"></a>00138         <span class="stringliteral">&quot;bst %3, %6                             \n\t&quot;</span>
<a name="l00139"></a>00139         <span class="stringliteral">&quot;bld %0, 1                              \n\t&quot;</span>
<a name="l00140"></a>00140         <span class="stringliteral">&quot;in %3, %5      ; Bit 0                 \n\t&quot;</span>
<a name="l00141"></a>00141         <span class="stringliteral">&quot;out %4, %1                             \n\t&quot;</span>
<a name="l00142"></a>00142         <span class="stringliteral">&quot;bst %3, %6                             \n\t&quot;</span>
<a name="l00143"></a>00143         <span class="stringliteral">&quot;bld %0, 0                                  &quot;</span>
<a name="l00144"></a>00144         : <span class="stringliteral">&quot;=&amp;r&quot;</span> (data) <span class="comment">/* %0 */</span>, <span class="stringliteral">&quot;=&amp;r&quot;</span> (clk_high) <span class="comment">/* %1 */</span>, <span class="stringliteral">&quot;=&amp;r&quot;</span> (clk_low) <span class="comment">/* %2 */</span>, <span class="stringliteral">&quot;=&amp;r&quot;</span> (port_data) <span class="comment">/* %3 */</span>
<a name="l00145"></a>00145         : <span class="stringliteral">&quot;M&quot;</span> (PORT_OUT) <span class="comment">/* %4 */</span>, <span class="stringliteral">&quot;M&quot;</span> (PORT_IN) <span class="comment">/* %5 */</span>, <span class="stringliteral">&quot;M&quot;</span> (<a class="code" href="mmc-low_8h.html#a57666f9e6290a14874b7111990543ec2">SPI_DI</a>) <span class="comment">/* %6 */</span>, <span class="stringliteral">&quot;M&quot;</span> (_BV(<a class="code" href="mmc-low_8h.html#af3cfe48f6efdc257518227b43c1bc3df">SPI_CLK</a>)) <span class="comment">/* %7 */</span>
<a name="l00146"></a>00146         : <span class="stringliteral">&quot;memory&quot;</span>
<a name="l00147"></a>00147     );
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     <span class="keywordflow">return</span> data;
<a name="l00150"></a>00150 }
<a name="l00151"></a>00151 
<a name="l00158"></a>00158 uint8_t <a class="code" href="mmc_8h.html#a8b7742b9c060af7db1aa56e1d9676918">mmc_write_sector</a>(uint32_t addr, <span class="keywordtype">void</span> * buffer) {
<a name="l00159"></a>00159     (void) addr;
<a name="l00160"></a>00160     (void) buffer;
<a name="l00161"></a>00161 
<a name="l00162"></a>00162     <span class="keyword">register</span> uint8_t result <span class="keyword">asm</span>(<span class="stringliteral">&quot;r24&quot;</span>);
<a name="l00163"></a>00163     __asm__ __volatile__(
<a name="l00164"></a>00164         <span class="stringliteral">&quot;push r13                   ; allgemeine Register retten                \n\t&quot;</span>
<a name="l00165"></a>00165         <span class="stringliteral">&quot;push r14                                                               \n\t&quot;</span>
<a name="l00166"></a>00166         <span class="stringliteral">&quot;push r15                                                               \n\t&quot;</span>
<a name="l00167"></a>00167         <span class="stringliteral">&quot;push r16                                                               \n\t&quot;</span>
<a name="l00168"></a>00168         <span class="stringliteral">&quot;push r28                                                               \n\t&quot;</span>
<a name="l00169"></a>00169         <span class="stringliteral">&quot;push r29                                                               \n\t&quot;</span>
<a name="l00170"></a>00170         <span class="stringliteral">&quot;movw r14, r22              ; Byte 1 und 2 von Parameter addr sichern   \n\t&quot;</span>
<a name="l00171"></a>00171         <span class="stringliteral">&quot;mov r16, r24               ; Byte 3 von Parameter addr sichern         \n\t&quot;</span>
<a name="l00172"></a>00172         <span class="stringliteral">&quot;movw r28, r20              ; Parameter Buffer sichern                  \n\t&quot;</span>
<a name="l00173"></a>00173 #ifdef <a class="code" href="ct-Bot_8h.html#ab14aa6ff0546f62628e46f27b0858f67">OS_AVAILABLE</a>
<a name="l00174"></a>00174         <span class="stringliteral">&quot;sts os_scheduling_allowed, r1  ; os_enterCS()                          \n\t&quot;</span>
<a name="l00175"></a>00175 #endif
<a name="l00176"></a>00176 #ifdef <a class="code" href="ct-Bot_8h.html#a2f3ec9fa00a39653bbae34e51c2f8bd4">LED_AVAILABLE</a>
<a name="l00177"></a>00177         <span class="stringliteral">&quot;lds r24, led                                                           \n\t&quot;</span>
<a name="l00178"></a>00178         <span class="stringliteral">&quot;ori r24, %0                                                            \n\t&quot;</span>
<a name="l00179"></a>00179         <span class="stringliteral">&quot;sts led, r24                                                           \n\t&quot;</span>
<a name="l00180"></a>00180         <span class="stringliteral">&quot;call LED_set               ; rote LED an                               \n\t&quot;</span>
<a name="l00181"></a>00181 #endif <span class="comment">// LED_AVAILABLE</span>
<a name="l00182"></a>00182         <span class="stringliteral">&quot;call mmc_enable            ; Karte aktiv schalten                      \n\t&quot;</span>
<a name="l00183"></a>00183         <span class="stringliteral">&quot;tst r24                                                                \n\t&quot;</span>
<a name="l00184"></a>00184         <span class="stringliteral">&quot;breq 1f                                                                \n\t&quot;</span>
<a name="l00185"></a>00185         <span class="stringliteral">&quot;rjmp 4f                    ; Karte kann nicht initialisiert werden =&gt; Fehler       \n\t&quot;</span>
<a name="l00186"></a>00186         <span class="stringliteral">&quot;1:                                                                                 \n\t&quot;</span>
<a name="l00187"></a>00187         <span class="stringliteral">&quot;lsl r14                    ; Block in Bytes umrechnen                              \n\t&quot;</span>
<a name="l00188"></a>00188         <span class="stringliteral">&quot;rol r15                                                                            \n\t&quot;</span>
<a name="l00189"></a>00189         <span class="stringliteral">&quot;rol r16                                                                            \n\t&quot;</span>
<a name="l00190"></a>00190         <span class="stringliteral">&quot;ldi r24, 88                ; Kommando 24 zum Schreiben eines Blocks senden, Byte 0 \n\t&quot;</span>
<a name="l00191"></a>00191         <span class="stringliteral">&quot;call mmc_write_byte                                                                \n\t&quot;</span>
<a name="l00192"></a>00192         <span class="stringliteral">&quot;mov r24, r16               ; Byte 1        \n\t&quot;</span>
<a name="l00193"></a>00193         <span class="stringliteral">&quot;call mmc_write_byte                        \n\t&quot;</span>
<a name="l00194"></a>00194         <span class="stringliteral">&quot;mov r24, r15               ; Byte 2        \n\t&quot;</span>
<a name="l00195"></a>00195         <span class="stringliteral">&quot;call mmc_write_byte                        \n\t&quot;</span>
<a name="l00196"></a>00196         <span class="stringliteral">&quot;mov r24, r14               ; Byte 3        \n\t&quot;</span>
<a name="l00197"></a>00197         <span class="stringliteral">&quot;call mmc_write_byte                        \n\t&quot;</span>
<a name="l00198"></a>00198         <span class="stringliteral">&quot;ldi r24, 0                 ; Byte 4        \n\t&quot;</span>
<a name="l00199"></a>00199         <span class="stringliteral">&quot;call mmc_write_byte                        \n\t&quot;</span>
<a name="l00200"></a>00200         <span class="stringliteral">&quot;ldi r24, lo8(-1)           ; Byte 5 (CRC)  \n\t&quot;</span>
<a name="l00201"></a>00201         <span class="stringliteral">&quot;call mmc_write_byte                        \n\t&quot;</span>
<a name="l00202"></a>00202         <span class="stringliteral">&quot;clr r13                    ; Timeout nach 256 Versuchen    \n\t&quot;</span>
<a name="l00203"></a>00203         <span class="stringliteral">&quot;1:                                                         \n\t&quot;</span>
<a name="l00204"></a>00204         <span class="stringliteral">&quot;call mmc_read_byte                                         \n\t&quot;</span>
<a name="l00205"></a>00205         <span class="stringliteral">&quot;cpi r24, lo8(-1)           ; !0xff = Antwort               \n\t&quot;</span>
<a name="l00206"></a>00206         <span class="stringliteral">&quot;brne 3f                                                    \n\t&quot;</span>
<a name="l00207"></a>00207 #ifdef <a class="code" href="ct-Bot_8h.html#ab14aa6ff0546f62628e46f27b0858f67">OS_AVAILABLE</a>
<a name="l00208"></a>00208         <span class="stringliteral">&quot;call os_exitCS                 ; os_exitCS()               \n\t&quot;</span>
<a name="l00209"></a>00209         <span class="stringliteral">&quot;sts os_scheduling_allowed, r1  ; os_enterCS()              \n\t&quot;</span>
<a name="l00210"></a>00210 #endif
<a name="l00211"></a>00211         <span class="stringliteral">&quot;dec r13                ; r13--     \n\t&quot;</span>
<a name="l00212"></a>00212         <span class="stringliteral">&quot;brne 1b                            \n\t&quot;</span>
<a name="l00213"></a>00213         <span class="stringliteral">&quot;3:                                 \n\t&quot;</span>
<a name="l00214"></a>00214         <span class="stringliteral">&quot;tst r13                ; Fehler oder Abbruch durch Timeout?    \n\t&quot;</span>
<a name="l00215"></a>00215         <span class="stringliteral">&quot;brne 1f                                                \n\t&quot;</span>
<a name="l00216"></a>00216         <span class="stringliteral">&quot;rjmp 4f                ; Return-Code 1                 \n\t&quot;</span>
<a name="l00217"></a>00217         <span class="stringliteral">&quot;1:                                                     \n\t&quot;</span>
<a name="l00218"></a>00218         <span class="stringliteral">&quot;ldi r24, lo8(-2)       ; Start-Byte an Karte senden    \n\t&quot;</span>
<a name="l00219"></a>00219         <span class="stringliteral">&quot;call mmc_write_byte                            \n\t&quot;</span>
<a name="l00220"></a>00220         <span class="stringliteral">&quot;in r26, %1             ; MMC_PORT_OUT einlesen \n\t&quot;</span>
<a name="l00221"></a>00221         <span class="stringliteral">&quot;cbr r26, %2            ; CLK auf low           \n\t&quot;</span>
<a name="l00222"></a>00222         <span class="stringliteral">&quot;ldi r18, 2             ; r18 = 2               \n\t&quot;</span>
<a name="l00223"></a>00223         <span class="stringliteral">&quot;clr r27                ; r27 = 0               \n\t&quot;</span>
<a name="l00224"></a>00224         <span class="stringliteral">&quot;1:                                             \n\t&quot;</span>
<a name="l00225"></a>00225         <span class="stringliteral">&quot;ld r25, Y+             ; Byte aus SRAM lesen   \n\t&quot;</span>
<a name="l00226"></a>00226         <span class="stringliteral">&quot;bst r25, 7             ; Bit 7                 \n\t&quot;</span>
<a name="l00227"></a>00227         <span class="stringliteral">&quot;bld r26, %3                            \n\t&quot;</span>
<a name="l00228"></a>00228         <span class="stringliteral">&quot;out %1, r26            ; Daten senden  \n\t&quot;</span>
<a name="l00229"></a>00229         <span class="stringliteral">&quot;sbi %1, %4             ; CLK auf high  \n\t&quot;</span>
<a name="l00230"></a>00230         <span class="stringliteral">&quot;bst r25, 6             ; Bit 6 \n\t&quot;</span>
<a name="l00231"></a>00231         <span class="stringliteral">&quot;bld r26, %3                    \n\t&quot;</span>
<a name="l00232"></a>00232         <span class="stringliteral">&quot;out %1, r26                    \n\t&quot;</span>
<a name="l00233"></a>00233         <span class="stringliteral">&quot;sbi %1, %4                     \n\t&quot;</span>
<a name="l00234"></a>00234         <span class="stringliteral">&quot;bst r25, 5             ; Bit 5 \n\t&quot;</span>
<a name="l00235"></a>00235         <span class="stringliteral">&quot;bld r26, %3                    \n\t&quot;</span>
<a name="l00236"></a>00236         <span class="stringliteral">&quot;out %1, r26                    \n\t&quot;</span>
<a name="l00237"></a>00237         <span class="stringliteral">&quot;sbi %1, %4                     \n\t&quot;</span>
<a name="l00238"></a>00238         <span class="stringliteral">&quot;bst r25, 4             ; Bit 4 \n\t&quot;</span>
<a name="l00239"></a>00239         <span class="stringliteral">&quot;bld r26, %3                    \n\t&quot;</span>
<a name="l00240"></a>00240         <span class="stringliteral">&quot;out %1, r26                    \n\t&quot;</span>
<a name="l00241"></a>00241         <span class="stringliteral">&quot;sbi %1, %4                     \n\t&quot;</span>
<a name="l00242"></a>00242         <span class="stringliteral">&quot;bst r25, 3             ; Bit 3 \n\t&quot;</span>
<a name="l00243"></a>00243         <span class="stringliteral">&quot;bld r26, %3                    \n\t&quot;</span>
<a name="l00244"></a>00244         <span class="stringliteral">&quot;out %1, r26                    \n\t&quot;</span>
<a name="l00245"></a>00245         <span class="stringliteral">&quot;sbi %1, %4                     \n\t&quot;</span>
<a name="l00246"></a>00246         <span class="stringliteral">&quot;bst r25, 2             ; Bit 2 \n\t&quot;</span>
<a name="l00247"></a>00247         <span class="stringliteral">&quot;bld r26, %3                    \n\t&quot;</span>
<a name="l00248"></a>00248         <span class="stringliteral">&quot;out %1, r26                    \n\t&quot;</span>
<a name="l00249"></a>00249         <span class="stringliteral">&quot;sbi %1, %4                     \n\t&quot;</span>
<a name="l00250"></a>00250         <span class="stringliteral">&quot;bst r25, 1             ; Bit 1 \n\t&quot;</span>
<a name="l00251"></a>00251         <span class="stringliteral">&quot;bld r26, %3                    \n\t&quot;</span>
<a name="l00252"></a>00252         <span class="stringliteral">&quot;out %1, r26                    \n\t&quot;</span>
<a name="l00253"></a>00253         <span class="stringliteral">&quot;sbi %1, %4                     \n\t&quot;</span>
<a name="l00254"></a>00254         <span class="stringliteral">&quot;bst r25, 0             ; Bit 0 \n\t&quot;</span>
<a name="l00255"></a>00255         <span class="stringliteral">&quot;bld r26, %3                    \n\t&quot;</span>
<a name="l00256"></a>00256         <span class="stringliteral">&quot;out %1, r26                    \n\t&quot;</span>
<a name="l00257"></a>00257         <span class="stringliteral">&quot;sbi %1, %4                     \n\t&quot;</span>
<a name="l00258"></a>00258         <span class="stringliteral">&quot;inc r27                ; r27++     \n\t&quot;</span>
<a name="l00259"></a>00259         <span class="stringliteral">&quot;breq 2f                ; r27 == 0? \n\t&quot;</span>
<a name="l00260"></a>00260         <span class="stringliteral">&quot;rjmp 1b                            \n\t&quot;</span>
<a name="l00261"></a>00261         <span class="stringliteral">&quot;2:                                 \n\t&quot;</span>
<a name="l00262"></a>00262         <span class="stringliteral">&quot;dec r18                ; r18--     \n\t&quot;</span>
<a name="l00263"></a>00263         <span class="stringliteral">&quot;breq 3f                ; r18 == 0? \n\t&quot;</span>
<a name="l00264"></a>00264         <span class="stringliteral">&quot;rjmp 1b                            \n\t&quot;</span>
<a name="l00265"></a>00265         <span class="stringliteral">&quot;3:                                 \n\t&quot;</span>
<a name="l00266"></a>00266         <span class="stringliteral">&quot;sbi %1, %3     ; DO auf high       \n\t&quot;</span>
<a name="l00267"></a>00267         <span class="stringliteral">&quot;call mmc_write_byte        ; crc-Dummy schreiben   \n\t&quot;</span>
<a name="l00268"></a>00268         <span class="stringliteral">&quot;call mmc_write_byte                    \n\t&quot;</span>
<a name="l00269"></a>00269         <span class="stringliteral">&quot;clr r13                    ; r13 = 0   \n\t&quot;</span>
<a name="l00270"></a>00270         <span class="stringliteral">&quot;1:                                     \n\t&quot;</span>
<a name="l00271"></a>00271         <span class="stringliteral">&quot;clr r28                    ; r28 = 0   \n\t&quot;</span>
<a name="l00272"></a>00272         <span class="stringliteral">&quot;2:                                     \n\t&quot;</span>
<a name="l00273"></a>00273         <span class="stringliteral">&quot;call mmc_read_byte         ; warten, ob Karte noch busy    \n\t&quot;</span>
<a name="l00274"></a>00274         <span class="stringliteral">&quot;cpi r24, lo8(-1)                       \n\t&quot;</span>
<a name="l00275"></a>00275         <span class="stringliteral">&quot;breq 3f                    ; == 0xff?  \n\t&quot;</span>
<a name="l00276"></a>00276 #ifdef <a class="code" href="ct-Bot_8h.html#ab14aa6ff0546f62628e46f27b0858f67">OS_AVAILABLE</a>
<a name="l00277"></a>00277         <span class="stringliteral">&quot;call os_exitCS                 ; os_exitCS()   \n\t&quot;</span>
<a name="l00278"></a>00278         <span class="stringliteral">&quot;sts os_scheduling_allowed, r1  ; os_enterCS()  \n\t&quot;</span>
<a name="l00279"></a>00279 #endif
<a name="l00280"></a>00280         <span class="stringliteral">&quot;dec r28                        ; r28--         \n\t&quot;</span>
<a name="l00281"></a>00281         <span class="stringliteral">&quot;brne 2b                        ; r28 == 0?     \n\t&quot;</span>
<a name="l00282"></a>00282         <span class="stringliteral">&quot;dec r13                        ; r13--         \n\t&quot;</span>
<a name="l00283"></a>00283         <span class="stringliteral">&quot;brne 1b                        ; r13 == 0?     \n\t&quot;</span>
<a name="l00284"></a>00284         <span class="stringliteral">&quot;rjmp 5f                        ; Timeout :(    \n\t&quot;</span>
<a name="l00285"></a>00285         <span class="stringliteral">&quot;3:                                             \n\t&quot;</span>
<a name="l00286"></a>00286         <span class="stringliteral">&quot;ldi r16, 0                     ; Alles ok, also Return-Code 0 laden :) \n\t&quot;</span>
<a name="l00287"></a>00287         <span class="stringliteral">&quot;rjmp 6f                                                        \n\t&quot;</span>
<a name="l00288"></a>00288         <span class="stringliteral">&quot;4:                                                             \n\t&quot;</span>
<a name="l00289"></a>00289         <span class="stringliteral">&quot;ldi r16, 1                     ; Fehler, Return-Code 1 laden   \n\t&quot;</span>
<a name="l00290"></a>00290         <span class="stringliteral">&quot;sts mmc_init_state, r16        ; Initstatus auf Fehler setzen  \n\t&quot;</span>
<a name="l00291"></a>00291         <span class="stringliteral">&quot;rjmp 6f                                                        \n\t&quot;</span>
<a name="l00292"></a>00292         <span class="stringliteral">&quot;5:                                                             \n\t&quot;</span>
<a name="l00293"></a>00293         <span class="stringliteral">&quot;ldi r16, 2                     ; Fehler, Return-Code 2 laden   \n\t&quot;</span>
<a name="l00294"></a>00294         <span class="stringliteral">&quot;sts mmc_init_state, r16        ; Initstatus auf Fehler setzen  \n\t&quot;</span>
<a name="l00295"></a>00295         <span class="stringliteral">&quot;6:                                                             \n\t&quot;</span>
<a name="l00296"></a>00296         <span class="stringliteral">&quot;ldi r24, lo8(%5)               ; Karte inaktiv schalten    \n\t&quot;</span>
<a name="l00297"></a>00297         <span class="stringliteral">&quot;call ENA_off                                               \n\t&quot;</span>
<a name="l00298"></a>00298 #ifdef <a class="code" href="ct-Bot_8h.html#a2f3ec9fa00a39653bbae34e51c2f8bd4">LED_AVAILABLE</a>
<a name="l00299"></a>00299         <span class="stringliteral">&quot;lds r24, led                                   \n\t&quot;</span>
<a name="l00300"></a>00300         <span class="stringliteral">&quot;andi r24, ~%0                                  \n\t&quot;</span>
<a name="l00301"></a>00301         <span class="stringliteral">&quot;sts led, r24                                   \n\t&quot;</span>
<a name="l00302"></a>00302         <span class="stringliteral">&quot;call LED_set                   ; rote LED aus  \n\t&quot;</span>
<a name="l00303"></a>00303 #endif <span class="comment">// LED_AVAILABLE</span>
<a name="l00304"></a>00304 #ifdef <a class="code" href="ct-Bot_8h.html#ab14aa6ff0546f62628e46f27b0858f67">OS_AVAILABLE</a>
<a name="l00305"></a>00305         <span class="stringliteral">&quot;call os_exitCS                 ; os_exitCS()       \n\t&quot;</span>
<a name="l00306"></a>00306 #endif
<a name="l00307"></a>00307         <span class="stringliteral">&quot;mov    r24, r16                ; Return-Code laden \n\t&quot;</span>
<a name="l00308"></a>00308         <span class="stringliteral">&quot;ldi r25, 0                                         \n\t&quot;</span>
<a name="l00309"></a>00309         <span class="stringliteral">&quot;pop r29                        ; allgemeine Register wiederherstellen  \n\t&quot;</span>
<a name="l00310"></a>00310         <span class="stringliteral">&quot;pop r28    \n\t&quot;</span>
<a name="l00311"></a>00311         <span class="stringliteral">&quot;pop r16    \n\t&quot;</span>
<a name="l00312"></a>00312         <span class="stringliteral">&quot;pop r15    \n\t&quot;</span>
<a name="l00313"></a>00313         <span class="stringliteral">&quot;pop r14    \n\t&quot;</span>
<a name="l00314"></a>00314         <span class="stringliteral">&quot;pop r13    \n\t&quot;</span>
<a name="l00315"></a>00315         <span class="stringliteral">&quot;ret            &quot;</span>
<a name="l00316"></a>00316         :: <span class="stringliteral">&quot;M&quot;</span> (<a class="code" href="led_8h.html#a2eddf48fa63431bcbfcab672956ac233">LED_ROT</a>) <span class="comment">/* %0 */</span>, <span class="stringliteral">&quot;M&quot;</span> (PORT_OUT) <span class="comment">/* %1 */</span>, <span class="stringliteral">&quot;M&quot;</span> (_BV(<a class="code" href="mmc-low_8h.html#af3cfe48f6efdc257518227b43c1bc3df">SPI_CLK</a>)) <span class="comment">/* %2 */</span>, <span class="stringliteral">&quot;M&quot;</span> (<a class="code" href="mmc-low_8h.html#a8c0bc6cc240b5384d0a3c3778a2b0b12">SPI_DO</a>) <span class="comment">/* %3 */</span>,
<a name="l00317"></a>00317          <span class="stringliteral">&quot;M&quot;</span> (<a class="code" href="mmc-low_8h.html#af3cfe48f6efdc257518227b43c1bc3df">SPI_CLK</a>) <span class="comment">/* %4 */</span>, <span class="stringliteral">&quot;M&quot;</span> (<a class="code" href="ena_8h.html#a3ad1a6346c07216d560ebb698453d399">ENA_MMC</a>) <span class="comment">/* %5 */</span>
<a name="l00318"></a>00318         : <span class="stringliteral">&quot;memory&quot;</span>
<a name="l00319"></a>00319     );
<a name="l00320"></a>00320 
<a name="l00321"></a>00321     <span class="keywordflow">return</span> result;
<a name="l00322"></a>00322 }
<a name="l00323"></a>00323 
<a name="l00330"></a>00330 uint8_t <a class="code" href="mmc_8h.html#a7ebc2ededd906eb69ecc1d14e2caae45">mmc_read_sector</a>(uint32_t addr, <span class="keywordtype">void</span> * buffer) {
<a name="l00331"></a>00331     (void) addr;
<a name="l00332"></a>00332     (void) buffer;
<a name="l00333"></a>00333 
<a name="l00334"></a>00334     <span class="keyword">register</span> uint8_t result <span class="keyword">asm</span>(<span class="stringliteral">&quot;r24&quot;</span>);
<a name="l00335"></a>00335     __asm__ __volatile__(
<a name="l00336"></a>00336         <span class="stringliteral">&quot;push r14                   ; allgemeine Register retten    \n\t&quot;</span>
<a name="l00337"></a>00337         <span class="stringliteral">&quot;push r15   \n\t&quot;</span>
<a name="l00338"></a>00338         <span class="stringliteral">&quot;push r16   \n\t&quot;</span>
<a name="l00339"></a>00339         <span class="stringliteral">&quot;push r28   \n\t&quot;</span>
<a name="l00340"></a>00340         <span class="stringliteral">&quot;push r29   \n\t&quot;</span>
<a name="l00341"></a>00341         <span class="stringliteral">&quot;movw r14, r22              ; Byte 1 und 2 von Parameter addr sichern   \n\t&quot;</span>
<a name="l00342"></a>00342         <span class="stringliteral">&quot;mov r16, r24               ; Byte 3 von Parameter addr sichern         \n\t&quot;</span>
<a name="l00343"></a>00343         <span class="stringliteral">&quot;movw r28, r20              ; Parameter Buffer sichern                  \n\t&quot;</span>
<a name="l00344"></a>00344     #ifdef <a class="code" href="ct-Bot_8h.html#ab14aa6ff0546f62628e46f27b0858f67">OS_AVAILABLE</a>
<a name="l00345"></a>00345         <span class="stringliteral">&quot;sts os_scheduling_allowed, r1  ; os_enterCS()  \n\t&quot;</span>
<a name="l00346"></a>00346     #endif
<a name="l00347"></a>00347     #ifdef <a class="code" href="ct-Bot_8h.html#a2f3ec9fa00a39653bbae34e51c2f8bd4">LED_AVAILABLE</a>
<a name="l00348"></a>00348         <span class="stringliteral">&quot;lds r24, led                                   \n\t&quot;</span>
<a name="l00349"></a>00349         <span class="stringliteral">&quot;ori r24, %0                                    \n\t&quot;</span>
<a name="l00350"></a>00350         <span class="stringliteral">&quot;sts led, r24                                   \n\t&quot;</span>
<a name="l00351"></a>00351         <span class="stringliteral">&quot;call LED_set               ; gruene LED an     \n\t&quot;</span>
<a name="l00352"></a>00352     #endif <span class="comment">// LED_AVAILABLE</span>
<a name="l00353"></a>00353         <span class="stringliteral">&quot;call mmc_enable            ; Karte aktiv schalten  \n\t&quot;</span>
<a name="l00354"></a>00354         <span class="stringliteral">&quot;tst r24                                            \n\t&quot;</span>
<a name="l00355"></a>00355         <span class="stringliteral">&quot;breq 1f                                            \n\t&quot;</span>
<a name="l00356"></a>00356         <span class="stringliteral">&quot;rjmp 5f                    ; Karte kann nicht initialisiert werden =&gt; Fehler   \n\t&quot;</span>
<a name="l00357"></a>00357         <span class="stringliteral">&quot;1:                                                     \n\t&quot;</span>
<a name="l00358"></a>00358         <span class="stringliteral">&quot;lsl r14                    ; Block in Bytes umrechnen  \n\t&quot;</span>
<a name="l00359"></a>00359         <span class="stringliteral">&quot;rol r15                                                \n\t&quot;</span>
<a name="l00360"></a>00360         <span class="stringliteral">&quot;rol r16                                                \n\t&quot;</span>
<a name="l00361"></a>00361         <span class="stringliteral">&quot;ldi r24, 81                ; Kommando 17 zum Lesen eines Blocks senden, Byte 0 \n\t&quot;</span>
<a name="l00362"></a>00362         <span class="stringliteral">&quot;call mmc_write_byte                    \n\t&quot;</span>
<a name="l00363"></a>00363         <span class="stringliteral">&quot;mov r24, r16               ; Byte 1    \n\t&quot;</span>
<a name="l00364"></a>00364         <span class="stringliteral">&quot;call mmc_write_byte                    \n\t&quot;</span>
<a name="l00365"></a>00365         <span class="stringliteral">&quot;mov r24, r15               ; Byte 2    \n\t&quot;</span>
<a name="l00366"></a>00366         <span class="stringliteral">&quot;call mmc_write_byte                    \n\t&quot;</span>
<a name="l00367"></a>00367         <span class="stringliteral">&quot;mov r24, r14               ; Byte 3    \n\t&quot;</span>
<a name="l00368"></a>00368         <span class="stringliteral">&quot;call mmc_write_byte                    \n\t&quot;</span>
<a name="l00369"></a>00369         <span class="stringliteral">&quot;ldi r24, 0                 ; Byte 4    \n\t&quot;</span>
<a name="l00370"></a>00370         <span class="stringliteral">&quot;call mmc_write_byte                    \n\t&quot;</span>
<a name="l00371"></a>00371         <span class="stringliteral">&quot;ldi r24,lo8(-1)            ; Byte 5 (CRC)  \n\t&quot;</span>
<a name="l00372"></a>00372         <span class="stringliteral">&quot;call mmc_write_byte                        \n\t&quot;</span>
<a name="l00373"></a>00373         <span class="stringliteral">&quot;ldi r16, lo8(-1)           ; Timeout bei 256   \n\t&quot;</span>
<a name="l00374"></a>00374         <span class="stringliteral">&quot;1:                                             \n\t&quot;</span>
<a name="l00375"></a>00375     #ifdef <a class="code" href="ct-Bot_8h.html#ab14aa6ff0546f62628e46f27b0858f67">OS_AVAILABLE</a>
<a name="l00376"></a>00376         <span class="stringliteral">&quot;sts os_scheduling_allowed, r1  ; os_enterCS()  \n\t&quot;</span>
<a name="l00377"></a>00377     #endif
<a name="l00378"></a>00378         <span class="stringliteral">&quot;call mmc_read_byte                             \n\t&quot;</span>
<a name="l00379"></a>00379         <span class="stringliteral">&quot;cpi r24, lo8(-2)           ; 0xfe = Startbyte  \n\t&quot;</span>
<a name="l00380"></a>00380         <span class="stringliteral">&quot;breq 2f                                        \n\t&quot;</span>
<a name="l00381"></a>00381         <span class="stringliteral">&quot;call mmc_read_byte         ; Noch ein Versuch  \n\t&quot;</span>
<a name="l00382"></a>00382         <span class="stringliteral">&quot;cpi r24, lo8(-2)                               \n\t&quot;</span>
<a name="l00383"></a>00383         <span class="stringliteral">&quot;breq 2f                                        \n\t&quot;</span>
<a name="l00384"></a>00384     #ifdef <a class="code" href="ct-Bot_8h.html#ab14aa6ff0546f62628e46f27b0858f67">OS_AVAILABLE</a>
<a name="l00385"></a>00385         <span class="stringliteral">&quot;call os_exitCS             ; os_ExitCS()       \n\t&quot;</span>
<a name="l00386"></a>00386     #endif
<a name="l00387"></a>00387         <span class="stringliteral">&quot;dec r16                                        \n\t&quot;</span>
<a name="l00388"></a>00388         <span class="stringliteral">&quot;brne 1b                                        \n\t&quot;</span>
<a name="l00389"></a>00389         <span class="stringliteral">&quot;rjmp 4f                ; Timeout, also abbrechen :(    \n\t&quot;</span>
<a name="l00390"></a>00390         <span class="stringliteral">&quot;2:                                             \n\t&quot;</span>
<a name="l00391"></a>00391         <span class="stringliteral">&quot;in r20, %1             ; MMC_PORT_OUT einlesen \n\t&quot;</span>
<a name="l00392"></a>00392         <span class="stringliteral">&quot;cbr r20, %2            ; CLK low       \n\t&quot;</span>
<a name="l00393"></a>00393         <span class="stringliteral">&quot;out %1, r20            ; CLK auf low   \n\t&quot;</span>
<a name="l00394"></a>00394         <span class="stringliteral">&quot;mov r19, r20           ; CLK high      \n\t&quot;</span>
<a name="l00395"></a>00395         <span class="stringliteral">&quot;sbr r19, %2                            \n\t&quot;</span>
<a name="l00396"></a>00396         <span class="stringliteral">&quot;ldi r18, 2             ; Schleifenzaehler laden    \n\t&quot;</span>
<a name="l00397"></a>00397         <span class="stringliteral">&quot;clr r24                                    \n\t&quot;</span>
<a name="l00398"></a>00398         <span class="stringliteral">&quot;1:                                         \n\t&quot;</span>
<a name="l00399"></a>00399         <span class="stringliteral">&quot;in r26, %4             ; Bit 7 lesen       \n\t&quot;</span>
<a name="l00400"></a>00400         <span class="stringliteral">&quot;out %1, r19            ; CLK Flanke        \n\t&quot;</span>
<a name="l00401"></a>00401         <span class="stringliteral">&quot;out %1, r20                                \n\t&quot;</span>
<a name="l00402"></a>00402         <span class="stringliteral">&quot;bst r26, %3            ; Bit 7 speichern   \n\t&quot;</span>
<a name="l00403"></a>00403         <span class="stringliteral">&quot;bld r25, 7                     \n\t&quot;</span>
<a name="l00404"></a>00404         <span class="stringliteral">&quot;in r26, %4             ; Bit 6 \n\t&quot;</span>
<a name="l00405"></a>00405         <span class="stringliteral">&quot;out %1, r19                    \n\t&quot;</span>
<a name="l00406"></a>00406         <span class="stringliteral">&quot;out %1, r20                    \n\t&quot;</span>
<a name="l00407"></a>00407         <span class="stringliteral">&quot;bst r26, %3                    \n\t&quot;</span>
<a name="l00408"></a>00408         <span class="stringliteral">&quot;bld r25, 6                     \n\t&quot;</span>
<a name="l00409"></a>00409         <span class="stringliteral">&quot;in r26, %4             ; Bit 5 \n\t&quot;</span>
<a name="l00410"></a>00410         <span class="stringliteral">&quot;out %1, r19                    \n\t&quot;</span>
<a name="l00411"></a>00411         <span class="stringliteral">&quot;out %1 ,r20                    \n\t&quot;</span>
<a name="l00412"></a>00412         <span class="stringliteral">&quot;bst r26, %3                    \n\t&quot;</span>
<a name="l00413"></a>00413         <span class="stringliteral">&quot;bld r25, 5                     \n\t&quot;</span>
<a name="l00414"></a>00414         <span class="stringliteral">&quot;in r26, %4             ; Bit 4 \n\t&quot;</span>
<a name="l00415"></a>00415         <span class="stringliteral">&quot;out %1, r19                    \n\t&quot;</span>
<a name="l00416"></a>00416         <span class="stringliteral">&quot;out %1, r20                    \n\t&quot;</span>
<a name="l00417"></a>00417         <span class="stringliteral">&quot;bst r26, %3                    \n\t&quot;</span>
<a name="l00418"></a>00418         <span class="stringliteral">&quot;bld r25, 4                     \n\t&quot;</span>
<a name="l00419"></a>00419         <span class="stringliteral">&quot;in r26, %4             ; Bit 3 \n\t&quot;</span>
<a name="l00420"></a>00420         <span class="stringliteral">&quot;out %1, r19                    \n\t&quot;</span>
<a name="l00421"></a>00421         <span class="stringliteral">&quot;out %1, r20                    \n\t&quot;</span>
<a name="l00422"></a>00422         <span class="stringliteral">&quot;bst r26, %3                    \n\t&quot;</span>
<a name="l00423"></a>00423         <span class="stringliteral">&quot;bld r25, 3                     \n\t&quot;</span>
<a name="l00424"></a>00424         <span class="stringliteral">&quot;in r26, %4             ; Bit 2 \n\t&quot;</span>
<a name="l00425"></a>00425         <span class="stringliteral">&quot;out %1, r19                    \n\t&quot;</span>
<a name="l00426"></a>00426         <span class="stringliteral">&quot;out %1, r20                    \n\t&quot;</span>
<a name="l00427"></a>00427         <span class="stringliteral">&quot;bst r26, %3                    \n\t&quot;</span>
<a name="l00428"></a>00428         <span class="stringliteral">&quot;bld r25, 2                     \n\t&quot;</span>
<a name="l00429"></a>00429         <span class="stringliteral">&quot;in r26, %4             ; Bit 1 \n\t&quot;</span>
<a name="l00430"></a>00430         <span class="stringliteral">&quot;out %1, r19                    \n\t&quot;</span>
<a name="l00431"></a>00431         <span class="stringliteral">&quot;out %1, r20                    \n\t&quot;</span>
<a name="l00432"></a>00432         <span class="stringliteral">&quot;bst r26, %3                    \n\t&quot;</span>
<a name="l00433"></a>00433         <span class="stringliteral">&quot;bld r25, 1                     \n\t&quot;</span>
<a name="l00434"></a>00434         <span class="stringliteral">&quot;in r26, %4             ; Bit 0 \n\t&quot;</span>
<a name="l00435"></a>00435         <span class="stringliteral">&quot;out %1, r19                    \n\t&quot;</span>
<a name="l00436"></a>00436         <span class="stringliteral">&quot;out %1, r20                    \n\t&quot;</span>
<a name="l00437"></a>00437         <span class="stringliteral">&quot;bst r26, %3                    \n\t&quot;</span>
<a name="l00438"></a>00438         <span class="stringliteral">&quot;bld r25, 0                     \n\t&quot;</span>
<a name="l00439"></a>00439         <span class="stringliteral">&quot;st Y+, r25                 ; Byte ins SRAM kopieren    \n\t&quot;</span>
<a name="l00440"></a>00440         <span class="stringliteral">&quot;inc r24                    ; r24++                     \n\t&quot;</span>
<a name="l00441"></a>00441         <span class="stringliteral">&quot;breq 2f                    ; r24 == 0?                 \n\t&quot;</span>
<a name="l00442"></a>00442         <span class="stringliteral">&quot;rjmp 1b                                                \n\t&quot;</span>
<a name="l00443"></a>00443         <span class="stringliteral">&quot;2:                                                     \n\t&quot;</span>
<a name="l00444"></a>00444         <span class="stringliteral">&quot;dec r18                    ; r18--                     \n\t&quot;</span>
<a name="l00445"></a>00445         <span class="stringliteral">&quot;breq 3f                    ; r18 == 0?                 \n\t&quot;</span>
<a name="l00446"></a>00446         <span class="stringliteral">&quot;rjmp 1b                                                \n\t&quot;</span>
<a name="l00447"></a>00447         <span class="stringliteral">&quot;3:                                                     \n\t&quot;</span>
<a name="l00448"></a>00448         <span class="stringliteral">&quot;out %1, r19                ; CLK auf high              \n\t&quot;</span>
<a name="l00449"></a>00449         <span class="stringliteral">&quot;call mmc_read_byte         ; crc-Dummy lesen           \n\t&quot;</span>
<a name="l00450"></a>00450         <span class="stringliteral">&quot;call mmc_read_byte                                     \n\t&quot;</span>
<a name="l00451"></a>00451         <span class="stringliteral">&quot;4:                                                     \n\t&quot;</span>
<a name="l00452"></a>00452         <span class="stringliteral">&quot;tst r16                    ; Abbruch durch Timeout?    \n\t&quot;</span>
<a name="l00453"></a>00453         <span class="stringliteral">&quot;breq 5f                    ; r27 == 0?                 \n\t&quot;</span>
<a name="l00454"></a>00454         <span class="stringliteral">&quot;ldi r16, 0                 ; Alles ok, also Return-Code 0 laden :) \n\t&quot;</span>
<a name="l00455"></a>00455         <span class="stringliteral">&quot;rjmp 6f                                                            \n\t&quot;</span>
<a name="l00456"></a>00456         <span class="stringliteral">&quot;5:                                                                 \n\t&quot;</span>
<a name="l00457"></a>00457         <span class="stringliteral">&quot;ldi r16, 1                 ; Fehler, also Return-Code 1 laden      \n\t&quot;</span>
<a name="l00458"></a>00458         <span class="stringliteral">&quot;sts mmc_init_state, r16    ; Initstatus auf Fehler setzen          \n\t&quot;</span>
<a name="l00459"></a>00459         <span class="stringliteral">&quot;6:                                                                 \n\t&quot;</span>
<a name="l00460"></a>00460         <span class="stringliteral">&quot;ldi r24, lo8(%5)           ; Karte inaktiv schalten                \n\t&quot;</span>
<a name="l00461"></a>00461         <span class="stringliteral">&quot;call ENA_off                                                       \n\t&quot;</span>
<a name="l00462"></a>00462     #ifdef <a class="code" href="ct-Bot_8h.html#a2f3ec9fa00a39653bbae34e51c2f8bd4">LED_AVAILABLE</a>
<a name="l00463"></a>00463         <span class="stringliteral">&quot;lds r24, led           \n\t&quot;</span>
<a name="l00464"></a>00464         <span class="stringliteral">&quot;andi r24, ~%0          \n\t&quot;</span>
<a name="l00465"></a>00465         <span class="stringliteral">&quot;sts led, r24           \n\t&quot;</span>
<a name="l00466"></a>00466         <span class="stringliteral">&quot;call LED_set               ; gruene LED aus    \n\t&quot;</span>
<a name="l00467"></a>00467     #endif <span class="comment">// LED_AVAILABLE</span>
<a name="l00468"></a>00468     #ifdef <a class="code" href="ct-Bot_8h.html#ab14aa6ff0546f62628e46f27b0858f67">OS_AVAILABLE</a>
<a name="l00469"></a>00469         <span class="stringliteral">&quot;call os_exitCS             ; os_exitCS();      \n\t&quot;</span>
<a name="l00470"></a>00470     #endif
<a name="l00471"></a>00471         <span class="stringliteral">&quot;mov r24, r16               ; Return-Code laden \n\t&quot;</span>
<a name="l00472"></a>00472         <span class="stringliteral">&quot;ldi r25, 0                                                         \n\t&quot;</span>
<a name="l00473"></a>00473         <span class="stringliteral">&quot;pop r29                    ; allgemeine Register wiederherstellen  \n\t&quot;</span>
<a name="l00474"></a>00474         <span class="stringliteral">&quot;pop r28                \n\t&quot;</span>
<a name="l00475"></a>00475         <span class="stringliteral">&quot;pop r16                \n\t&quot;</span>
<a name="l00476"></a>00476         <span class="stringliteral">&quot;pop r15                \n\t&quot;</span>
<a name="l00477"></a>00477         <span class="stringliteral">&quot;pop r14                \n\t&quot;</span>
<a name="l00478"></a>00478         <span class="stringliteral">&quot;ret                        &quot;</span>
<a name="l00479"></a>00479         :: <span class="stringliteral">&quot;M&quot;</span> (<a class="code" href="led_8h.html#a821031f9c11c8a45d7b9ada7c0979d74">LED_GRUEN</a>) <span class="comment">/* %0 */</span>, <span class="stringliteral">&quot;M&quot;</span> (PORT_OUT) <span class="comment">/* %1 */</span>, <span class="stringliteral">&quot;M&quot;</span> (_BV(<a class="code" href="mmc-low_8h.html#af3cfe48f6efdc257518227b43c1bc3df">SPI_CLK</a>)) <span class="comment">/* %2 */</span>, <span class="stringliteral">&quot;M&quot;</span> (<a class="code" href="mmc-low_8h.html#a57666f9e6290a14874b7111990543ec2">SPI_DI</a>) <span class="comment">/* %3 */</span>,
<a name="l00480"></a>00480          <span class="stringliteral">&quot;M&quot;</span> (PORT_IN) <span class="comment">/* %4 */</span>, <span class="stringliteral">&quot;M&quot;</span> (<a class="code" href="ena_8h.html#a3ad1a6346c07216d560ebb698453d399">ENA_MMC</a>) <span class="comment">/* %5 */</span>
<a name="l00481"></a>00481         : <span class="stringliteral">&quot;memory&quot;</span>
<a name="l00482"></a>00482     );
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     <span class="keywordflow">return</span> result;
<a name="l00485"></a>00485 }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487 <span class="preprocessor">#endif // MMC_AVAILABLE &amp;&amp; ! SPI_AVAILABLE</span>
<a name="l00488"></a>00488 <span class="preprocessor"></span><span class="preprocessor">#endif // MCU</span>
<a name="l00489"></a>00489 <span class="preprocessor"></span>
</pre></div></div>
</div>


<hr class="footer"/><address class="footer"><small>
Erzeugt am Don Aug 18 2011 12:13:04 f√ºr c't-Bot von &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5
</small></address>

</body>
</html>
